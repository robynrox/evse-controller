{% extends "base.html" %}

{% block head %}
<title>EVSE Control</title>
<script src="{{ url_for('static', filename='js/plotly-2.29.1.min.js') }}"></script>
<script>
    // Icon filename constants
    const ICONS = {
        UNPLUG: "/static/images/Pause_to_remove_plug_black.svg",
        SOLAR: "/static/images/S2V_-_Solar_only_charging_black.svg",
        CHARGE: "/static/images/S2V_G2V_-_Solar_and_Grid_to_Battery_black.svg",
        DISCHARGE: "/static/images/V2G_-_Discharge_black.svg",
        POWER_HOME: "/static/images/V2H_-_Battery_to_House_black.svg",
        BALANCE: "/static/images/S2V_V2H_-_Solar_to_Battery_and_House_black.svg",
        PAUSE: "/static/images/On-Off_black.svg",
        OCTGO: "/static/images/Go_black.svg",
        FLUX: "/static/images/Flux_black.svg",
        COSY: "/static/images/Cosy_black.svg"
    };
</script>
<style>
    /* Override the default body constraints for the dashboard */

    body {
        max-width: none;
        margin: 20px;
        /* Keep some margin from the window edges */
    }
    @media (max-width: 600px) {
        body {
            margin: 4px;
        }
        .header-flex,
        .legend-container,
        #chart {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        h1, .status-panel, .nav-links {
            text-align: center;
            width: 100%;
        }
    }

    /* Page-specific styles only */
    #chart {
        width: 110%;
        height: 80vh;
        max-height: 600px;
    }

    .svg-button-container {
        margin-top: 15px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
</style>
{% endblock %}

{% block content %}


<div class="header-flex">
    <div>
        <h1>EVSE Control Interface</h1>
        <div class="status-panel" style="margin-bottom: 8px;">
                <div class="status-item">
                    <span class="status-info">
                        <strong>Battery:</strong> <span id="battery-soc" style="color: red;">Loading...</span>
                    </span>
                </div>
                <div class="status-item">
                    <span class="status-info">
                        <strong>Current State:</strong> <span id="current-state">Loading...</span>
                    </span>
                </div>
                <div class="status-item">
                    <strong>Next Scheduled Event:</strong> <span id="next-event">Loading...</span>
                </div>
        </div>
        <div class="nav-links">
            <a href="{{ url_for('schedule_page') }}">Schedule Events →</a>
            <a href="{{ url_for('config_page') }}">Configuration →</a>
        </div>
    </div>
</div>

<div class="svg-button-container">
    {% set button_defs = [
        ('unplug', 'Pause to remove plug', 'unplug-icon', 'Pause to remove plug'),
        ('solar', 'Charge using only solar power', 'solar-icon', 'Solar only charging'),
        ('charge', 'Charge battery at maximum rate using all power sources', 'charge-icon', 'Charge at maximum rate'),
        ('discharge', 'Discharge battery at maximum rate to power the home and send any excess back to the grid', 'discharge-icon', 'Discharge'),
        ('power-home', 'Discharge battery when necessary to power the home only', 'power-home-icon', 'Power Home'),
        ('balance', 'Minimise use of the grid (charge from solar and power the home)', 'balance-icon', 'Balance'),
        ('pause', 'Pause all charging/discharging', 'pause-icon', 'Pause'),
        ('octgo', 'Select the Octopus Go tariff controller', 'octgo-icon', 'Octopus Go'),
        ('flux', 'Select the Octopus Flux tariff controller', 'flux-icon', 'Octopus Flux'),
        ('cosy', 'Select the Cosy Octopus tariff controller', 'cosy-icon', 'Cosy Octopus'),
    ] %}
    {% set icon_urls = {
        'unplug': '/static/images/Pause_to_remove_plug_black.svg',
        'solar': '/static/images/S2V_-_Solar_only_charging_black.svg',
        'charge': '/static/images/S2V_G2V_-_Solar_and_Grid_to_Battery_black.svg',
        'discharge': '/static/images/V2G_-_Discharge_black.svg',
        'power-home': '/static/images/V2H_-_Battery_to_House_black.svg',
        'balance': '/static/images/S2V_V2H_-_Solar_to_Battery_and_House_black.svg',
        'pause': '/static/images/On-Off_black.svg',
        'octgo': '/static/images/Go_black.svg',
        'flux': '/static/images/Flux_black.svg',
        'cosy': '/static/images/Cosy_black.svg',
    } %}
    {% for key, title, icon_id, alt in button_defs %}
        {% if enabled_buttons and key in enabled_buttons %}
            <button class="svg-button" onclick="sendCommand('{{ key }}')" title="{{ title }}">
                <img src="{{ icon_urls[key] }}" id="{{ icon_id }}" alt="{{ alt }}">
            </button>

        {% endif %}
    {% endfor %}


</div> <!-- close svg-button-container -->

<h2 style="text-align:center;margin:10px 0 0 0;font-size:1.5em;">Power History</h2>
<div id="chart" style="width:100%;height:600px;"></div>

<style>
    .header-flex {
        display: flex;
        align-items: flex-start;
        gap: 32px;
        margin-bottom: 20px;
        width: 100%;
        max-width: 1200px;
        box-sizing: border-box;
        margin-left: auto;
        margin-right: auto;
    }
    .header-flex > div {
        width: 100%;
    }
    .status-panel {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        min-width: 260px;
        margin: 0;
        width: 100%;
        box-sizing: border-box;
    }
    .nav-links {
        width: 100%;
        max-width: 1200px;
        box-sizing: border-box;
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        justify-content: center;
        margin-left: auto;
        margin-right: auto;
    }
    @media (max-width: 1300px) {
        .header-flex, .nav-links {
            max-width: 100%;
        }
    }

    .status-item {
        margin: 10px 0;
    }

    .status-item strong {
        color: #495057;
    }


    .svg-button-container {
        margin-top: 15px;
        margin-bottom: 28px;
        display: flex;
        flex-wrap: wrap;
        gap: 18px;
        justify-content: center;
        align-items: center;
        width: 100%;
    }

    .svg-button {
        width: 70px;
        height: 70px;
        min-width: 70px;
        max-width: 70px;
        min-height: 70px;
        max-height: 70px;
        flex: 0 0 70px;
        padding: 0 !important;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        cursor: pointer;
        box-sizing: border-box;
        transition: background-color 0.2s, transform 0.2s;
    }

    @media (max-width: 600px) {
        .svg-button-container {
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 4px;
        }
        .svg-button {
            width: 56px;
            height: 56px;
            min-width: 56px;
            max-width: 56px;
            min-height: 56px;
            max-height: 56px;
            flex: 0 0 56px;
        }
        .svg-button img {
            width: 32px;
            height: 32px;
        }
    }

    .svg-button:hover {
        background-color: #e9ecef;
        transform: scale(1.05);
    }

    .svg-button:active {
        transform: scale(0.95);
    }

    .svg-button img {
        height: 38px;
        width: 38px;
        object-fit: contain;
        display: block;
        margin: 0 auto;
    }

    .legend-container {
        margin-top: 10px;
    }

    .legend-toggle {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px 20px;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color 0.2s;
        margin-left: auto;
    }

    .legend-toggle:hover {
        background-color: #e9ecef;
    }

    .command-legend {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 20px;
        margin-top: 10px;
        max-height: 2000px;
        transition: max-height 0.3s ease-out, opacity 0.3s ease-out, margin-top 0.3s ease-out;
        overflow: hidden;
        opacity: 1;
    }

    .command-legend.collapsed {
        max-height: 0;
        opacity: 0;
        margin-top: 0;
        padding: 0;
        border: none;
    }

    .legend-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 15px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .legend-item img {
        height: 30px;
        width: auto;
    }

    .legend-text {
        flex: 1;
    }

    .legend-text strong {
        display: block;
        margin-bottom: 4px;
    }

    @media (max-width: 768px) {
        .legend-grid {
            grid-template-columns: 1fr;
        }

        .legend-toggle {
            margin-left: 0;
            width: 100%;
        }

        .svg-button-container button:last-child {
            width: 100%;
        }

        .status-panel,
        .command-legend,
        .legend-toggle,
        .svg-button,
        .legend-item,
        .nav-links,
        .header-flex {
            border-width: 1px !important;
        }
        .status-panel,
        .command-legend,
        .legend-toggle,
        .svg-button,
        .legend-item {
            border-radius: 2px !important;
        }
    }
</style>

<script>
    // Set icon sources when page loads
    document.addEventListener('DOMContentLoaded', function () {
        // Set main button icons
        document.getElementById('unplug-icon').src = ICONS.UNPLUG;
        document.getElementById('solar-icon').src = ICONS.SOLAR;
        document.getElementById('charge-icon').src = ICONS.CHARGE;
        document.getElementById('discharge-icon').src = ICONS.DISCHARGE;
        document.getElementById('power-home-icon').src = ICONS.POWER_HOME;
        document.getElementById('balance-icon').src = ICONS.BALANCE;
        document.getElementById('pause-icon').src = ICONS.PAUSE;
        document.getElementById('octgo-icon').src = ICONS.OCTGO;
        document.getElementById('flux-icon').src = ICONS.FLUX;
        document.getElementById('cosy-icon').src = ICONS.COSY;

        // Set legend icons
        document.getElementById('legend-unplug-icon').src = ICONS.UNPLUG;
        document.getElementById('legend-solar-icon').src = ICONS.SOLAR;
        document.getElementById('legend-charge-icon').src = ICONS.CHARGE;
        document.getElementById('legend-discharge-icon').src = ICONS.DISCHARGE;
        document.getElementById('legend-power-home-icon').src = ICONS.POWER_HOME;
        document.getElementById('legend-balance-icon').src = ICONS.BALANCE;
        document.getElementById('legend-pause-icon').src = ICONS.PAUSE;
        document.getElementById('legend-octgo-icon').src = ICONS.OCTGO;
        document.getElementById('legend-flux-icon').src = ICONS.FLUX;
        document.getElementById('legend-cosy-icon').src = ICONS.COSY;
    });

    async function sendCommand(command) {
        try {
            const response = await fetch('/api/control/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ command: command })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message || 'Failed to send command');
            }
        } catch (error) {
            console.error('Error sending command:', error);
            alert('Failed to send command: ' + error.message);
        }
    }

    async function fetchHistory() {
        const response = await fetch('/api/status/history');
        const data = await response.json();
        return processHistoryData(data.entries, data.channel_metadata);
    }

    function processHistoryData(entries, metadata) {
        const timestamps = entries.map(entry => new Date(entry.timestamp * 1000));
        const channels = {};
        const channelConfigs = metadata.channels || {};

        // Initialize arrays for each active channel
        for (const device in channelConfigs) {
            for (const channelKey in channelConfigs[device]) {
                const channelConfig = channelConfigs[device][channelKey];
                if (channelConfig.in_use) {
                    channels[channelConfig.name] = new Array(entries.length).fill(0);
                }
            }
        }

        // Get grid channel info
        const gridRole = metadata.roles?.grid || {};
        const gridDevice = gridRole.device;
        const gridChannel = gridRole.channel;
        const gridName = gridDevice && gridChannel ?
            metadata.channels[gridDevice][`channel${gridChannel}`]?.name : null;

        // Process each entry
        entries.forEach((entry, index) => {
            const entryChannels = entry.channels || {};

            // Process each configured channel
            for (const device in channelConfigs) {
                const deviceData = entryChannels[device] || {};

                for (const channelKey in channelConfigs[device]) {
                    const channelConfig = channelConfigs[device][channelKey];
                    if (channelConfig.in_use) {
                        const channelNum = parseInt(channelKey.replace('channel', ''));
                        const power = deviceData[`channel${channelNum}`] || 0;
                        channels[channelConfig.name][index] = power;
                    }
                }
            }
        });

        // Calculate home power only if we have grid and at least one other channel
        let homePower = null;
        if (gridName && Object.keys(channels).length > 1) {
            homePower = new Array(entries.length).fill(0);
            for (let i = 0; i < entries.length; i++) {
                let total = channels[gridName][i];
                for (const [channelName, values] of Object.entries(channels)) {
                    if (channelName !== gridName) {
                        total -= values[i];
                    }
                }
                homePower[i] = total;
            }
        }

        return {
            timestamps: timestamps,
            channels: channels,
            homePower: homePower
        };
    }

    function isMobile() {
        return window.innerWidth <= 768; // Adjust the threshold as needed
    }

    function getLayout() {
        const isMobileDevice = isMobile();
        return {
            title: null,
            xaxis: {
                title: 'Time',
                tickmode: 'auto',
                nticks: 10,
                titlefont: { size: isMobileDevice ? 12 : 14 },
                tickfont: { size: isMobileDevice ? 10 : 12 }
            },
            yaxis: {
                title: 'Power (W)',
                titlefont: { size: isMobileDevice ? 12 : 14 },
                tickfont: { size: isMobileDevice ? 10 : 12 }
            },
            legend: {
                orientation: "h",
                yanchor: "top",
                y: -0.2,
                xanchor: "center",
                x: 0.5
            },
            responsive: true,
            autosize: true,
            margin: { l: 48, r: 0, b: 0, t: 0, pad: 0 } // Increased left margin for y-axis scale
        };
    }

    // Wrap all our initialization code in a DOMContentLoaded event handler
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize the empty chart - traces will be added dynamically
        Plotly.newPlot('chart', [], getLayout(), {
            displayModeBar: false,
            staticPlot: true
        });

        let firstLoad = true;

        async function updateChart() {
            try {
                const history = await fetchHistory();
                const traces = [];

                // Add a trace for each active channel
                for (const [channelName, values] of Object.entries(history.channels)) {
                    traces.push({
                        x: history.timestamps,
                        y: values,
                        name: channelName,
                        type: 'scatter'
                    });
                }

                // Add home power trace if available
                if (history.homePower) {
                    traces.push({
                        x: history.timestamps,
                        y: history.homePower,
                        name: 'Home',
                        type: 'scatter'
                    });
                }

                const layout = getLayout();

                if (firstLoad) {
                    Plotly.newPlot('chart', traces, layout, {
                        displayModeBar: false,
                        staticPlot: true
                    });
                    firstLoad = false;
                } else {
                    Plotly.react('chart', traces, layout, {
                        displayModeBar: false,
                        staticPlot: true
                    });
                }
            } catch (error) {
                console.error('Error updating chart:', error);
            }
        }

        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                // Update current state
                const stateElement = document.getElementById('current-state');
                stateElement.textContent = data.current_state.replace(/_/g, ' ');

                // Update battery SOC if available
                const socElement = document.getElementById('battery-soc');
                if (data.battery_soc !== undefined) {
                    socElement.textContent = `${data.battery_soc}%`;
                } else {
                    socElement.textContent = 'Unknown';
                }

                // Update next event
                const nextEventElement = document.getElementById('next-event');
                if (data.next_event) {
                    const eventTime = new Date(data.next_event.timestamp);
                    const formattedTime = eventTime.toLocaleString(undefined, {
                        dateStyle: 'short',
                        timeStyle: 'short'
                    });
                    nextEventElement.textContent = `${data.next_event.state} at ${formattedTime}`;
                } else {
                    nextEventElement.textContent = 'No events scheduled';
                }
            } catch (error) {
                console.error('Error fetching status:', error);
                document.getElementById('current-state').textContent = 'Error';
                document.getElementById('battery-soc').textContent = 'Error';
                document.getElementById('next-event').textContent = 'Unable to fetch status';
            }
        }

        // Set up update intervals
        setInterval(updateChart, 2000);  // Every 2 seconds
        setInterval(updateStatus, 5000); // Every 5 seconds

        // Initial calls
        updateChart();
        updateStatus();

        // Add resize handler
        window.addEventListener('resize', () => {
            Plotly.relayout('chart', getLayout());
        });
    });

    function toggleLegend() {
        const legend = document.getElementById('command-legend');
        legend.classList.toggle('collapsed');
    }
</script>
{% endblock %}